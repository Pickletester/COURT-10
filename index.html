<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court Display — 10 (NY Time, WTA 15s, Pulse Sync)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    html, body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:transparent; font-family: Arial, Helvetica, sans-serif; }
    :root { --bar-height: 72px; }

    /* Bottom bar (72px) */
    .graphic-bar{
      position:fixed; left:0; right:0; bottom:0; height:var(--bar-height);
      background: linear-gradient(90deg,#14203a,#22335d 70%);
      display:grid;
      grid-template-columns: 1.3fr 2.2fr 1.1fr 2.1fr 1.3fr;
      gap:4px; padding:4px 6px; box-sizing:border-box; z-index:1000;
    }

    /* Base section */
    .section{
      position:relative;
      display:flex; flex-direction:column;
      justify-content:center;            /* keep original vertical feel */
      align-items:center;                 /* center horizontally */
      overflow:hidden; border-radius:6px; isolation:isolate;
    }

    /* Solid dark panel (hardware-safe) */
    .section .compat-bg{
      position:absolute; left:3px; right:3px; top:3px; bottom:3px;
      background:#000; opacity:0.78; border-radius:6px; z-index:0; pointer-events:none;
    }

    /* Remove dark box behind the big number */
    #court-number .compat-bg { display:none !important; }

    /* Labels & text */
    .label{ font-weight:700; text-transform:uppercase; font-size:10px; letter-spacing:0.08em; z-index:2; margin-bottom:1px; }
    #current-event .label{ color:#6cff6c; }
    #next-event    .label{ color:#ffe56b; }
    #countdown     .label{ color:#d4e5fd; }
    #current-time  .label{ color:#d4e5fd; }

    .meta{ font-size:10px; color:#d8d8d8; opacity:.9; line-height:1.05; }

    .value{ font-weight:800; z-index:2; text-align:center; line-height:1.05; color:#fff; padding:0 4px; }

    /* Allow title to extend downward; keep top behavior unchanged */
    #current-event .value,
    #next-event .value{
      font-size:14px;
      max-height:none !important;
      overflow:visible !important;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
      padding:0 6px 3px;
      align-self:center;
    }

    /* Countdown & clock sizes */
    #countdown .value{ font-size:20px; }
    #current-time .value{ font-size:16px; }

    /* Big court number (no "Court" label) */
    #court-number{ display:flex; align-items:center; justify-content:center; }
    #court-number .value{
      font-size:58px; font-weight:900; padding:2px 12px; letter-spacing:0.02em;
      border:2px solid #ffffff; border-radius:8px;
      text-shadow:0 1px 2px rgba(0,0,0,0.4);
      background:linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.03));
      color:#fff; line-height:1;
    }

    /* Countdown pulse layers */
    #countdown .cdFill, #countdown .cdBorder{
      position:absolute; left:2px; right:2px; top:2px; bottom:2px;
      border-radius:6px; pointer-events:none; z-index:1; display:none;
    }
    #countdown.under-minute .cdFill{
      background:#ff0000; opacity:.40; display:block; animation:pulseFillSimple .70s ease-in-out infinite;
    }
    #countdown.under-minute .cdBorder{
      border:4px solid #ff0000; display:block; animation:pulseBorderSimple .70s ease-in-out infinite;
    }
    @keyframes pulseFillSimple{ 0%{opacity:.40} 50%{opacity:.95} 100%{opacity:.40} }
    @keyframes pulseBorderSimple{ 0%{opacity:1} 50%{opacity:.55} 100%{opacity:1} }

    /* Full-screen red pulse sync */
    #globalPulse{
      position:fixed; left:0; top:0; right:0; bottom:0; background:#ff0000; opacity:0; pointer-events:none; display:none; z-index:99999;
    }
    body.global-under-minute #globalPulse{ display:block; animation:globalPulse .70s ease-in-out infinite; }
    @keyframes globalPulse{ 0%{opacity:.15} 50%{opacity:.60} 100%{opacity:.15} }

    @keyframes cdColorPulse{ 0%{color:#ff0000} 50%{color:#ffffff} 100%{color:#ff0000} }
    body.global-under-minute #countdown #cd-val{ animation:cdColorPulse .70s ease-in-out infinite; }

    /* Phase-lock all pulse animations */
    body.global-under-minute #globalPulse,
    body.global-under-minute #countdown .cdFill,
    body.global-under-minute #countdown .cdBorder,
    body.global-under-minute #countdown #cd-val{
      animation-delay: var(--pulse-phase, 0ms);
    }

    *{ -webkit-user-select:none; user-select:none; }
  </style>
</head>
<body>
  <div class="graphic-bar" id="bar">
    <!-- BIG number only (no dark box behind) -->
    <div id="court-number" class="section">
      <div class="value" id="court-val">10</div>
    </div>

    <div id="current-event" class="section">
      <div class="compat-bg"></div>
      <div class="label" id="cur-label">In Progress</div>
      <div class="value" id="cur-val">Loading...</div>
    </div>

    <div id="countdown" class="section">
      <div class="compat-bg"></div>
      <div class="label" id="cd-label">Time Left</div>
      <div class="value" id="cd-val">--</div>
      <div class="cdFill"></div>
      <div class="cdBorder"></div>
    </div>

    <div id="next-event" class="section">
      <div class="compat-bg"></div>
      <div class="label">Upcoming</div>
      <div class="value" id="next-val">Loading next...</div>
    </div>

    <div id="current-time" class="section">
      <div class="compat-bg"></div>
      <div class="label">Current Time</div>
      <div class="value" id="clock">--:--</div>
    </div>
  </div>

  <!-- Full-screen pulse overlay -->
  <div id="globalPulse"></div>

  <script>
    /* ===== World Time API drift sync (robust @ 15s) ===== */
    let DRIFT_MS = 0;
    const PULSE_PERIOD_MS = 700;
    const RESYNC_MS = 15000;
    const MAX_STEP_MS = 200;
    const OUTLIER_MS = 2000;

    function parseHttpDate(dateStr){ const t=Date.parse(dateStr); return isNaN(t)? null : t; }

    async function getServerOffsetOnce(){
      const url='https://worldtimeapi.org/api/timezone/Etc/UTC';
      const t0=Date.now();
      const resp=await fetch(url,{cache:'no-store'});
      const t2=Date.now();

      let serverMs=null;
      try{ const data=await resp.clone().json(); if(typeof data.unixtime==='number') serverMs=data.unixtime*1000; }catch(_){}
      if(serverMs===null){
        const hdr=resp.headers.get('Date'); const hdrMs=hdr? parseHttpDate(hdr) : null;
        if(hdrMs!=null) serverMs=hdrMs;
      }
      if(serverMs===null) throw new Error('No server time');
      const mid=(t0+t2)/2;
      return {offset:serverMs-mid, rtt:t2-t0};
    }
    function median(a){ const s=[...a].sort((x,y)=>x-y); return s[Math.floor(s.length/2)]; }
    async function syncDrift(){
      try{
        const samples=[];
        for(let i=0;i<5;i++){ const {offset}=await getServerOffsetOnce(); samples.push(offset); }
        const newMedian=median(samples);
        if(Math.abs(newMedian-DRIFT_MS)>OUTLIER_MS) return;
        const desired=DRIFT_MS*0.9 + newMedian*0.1;
        const delta=desired-DRIFT_MS;
        const applied=Math.abs(delta)>MAX_STEP_MS ? (DRIFT_MS + Math.sign(delta)*MAX_STEP_MS) : desired;
        DRIFT_MS = applied;
      }catch(e){ /* keep last drift */ }
    }
    function nowSyncMs(){ return Date.now()+DRIFT_MS; }
    function setPulsePhase(){ const phase = nowSyncMs()%PULSE_PERIOD_MS; document.documentElement.style.setProperty('--pulse-phase', `-${phase}ms`); }
    document.addEventListener('DOMContentLoaded', ()=>{ syncDrift(); setInterval(syncDrift, RESYNC_MS); });

    /* ===== Under-minute fallback (ensures pulse toggles) ===== */
    (function(){
      function isUnderMinuteText(t){
        if(!t) return false;
        t=String(t).trim().toLowerCase();
        if(t==='time expired' || t==='--' || t.indexOf('no event')!==-1) return false;
        const m=t.match(/^(\d{1,3})\s*s\b/); return m ? (parseInt(m[1],10) < 60) : false;
      }
      function applyState(){
        const box=document.getElementById('countdown');
        const val=document.getElementById('cd-val');
        if(!box||!val) return;
        const _um=isUnderMinuteText(val.textContent);
        box.classList.toggle('under-minute', _um);
        document.body.classList.toggle('global-under-minute', _um);
        if(_um) setPulsePhase();
      }
      const target=document.getElementById('cd-val');
      if(target){ const obs=new MutationObserver(applyState); obs.observe(target,{characterData:true, childList:true, subtree:true}); }
      setInterval(applyState, 500);
      document.addEventListener('DOMContentLoaded', applyState);
      window.addEventListener('load', applyState);
    })();

    /* ===== Court / API settings ===== */
    let COURT_NO = 10; // will be overridden by ?court= query param if present
    const AUTH_B64 = "Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA==";
    const ORG_MEMBER_ID = "12674";
    const TZ = "America/New_York";

    // Optional: allow override via URL, e.g. index.html?court=7
    (function(){
      const params = new URLSearchParams(location.search);
      const q = parseInt(params.get('court'), 10);
      if (!isNaN(q) && q > 0) {
        COURT_NO = q;
        const cv = document.getElementById('court-val');
        if (cv) cv.textContent = String(COURT_NO);
      }
    })();

    /* Helpers */
    function parseTimeAny(t, baseDateLocal=null){
      if(t==null || t==="") return null;
      if(t instanceof Date) return isNaN(t.getTime())? null : t;
      if(typeof t==="number"){ return new Date(t>1e12 ? t : t*1000); }
      if(typeof t==="string"){
        const s=t.trim();
        const m=s.match(/^\/Date\((\d+)\)\/$/i); if(m) return new Date(parseInt(m[1],10));
        if(/^\d{1,2}:\d{2}(\s*[AP]M)?$/i.test(s)){
          const base=baseDateLocal || new Date();
          const [hhmm,ampmRaw]=s.split(/\s+/); let [hh,mm]=hhmm.split(':').map(x=>parseInt(x,10));
          const ampm=ampmRaw? ampmRaw.toUpperCase():null;
          if(ampm){ if(ampm==='PM'&&hh<12) hh+=12; if(ampm==='AM'&&hh===12) hh=0; }
          return new Date(base.getFullYear(), base.getMonth(), base.getDate(), hh, mm, 0, 0);
        }
        const d=new Date(s); if(!isNaN(d.getTime())) return d;
      }
      return null;
    }

    function pickArray(container){
      if(!container) return [];
      if(Array.isArray(container)) return container;
      if(typeof container==='object'){
        const keys=['Data','data','Results','Items','Reservations','ReservationList'];
        for(const k of keys){ if(Array.isArray(container[k])) return container[k]; }
        if(container.Data && typeof container.Data==='object'){
          for(const k of keys){ if(Array.isArray(container.Data[k])) return container.Data[k]; }
        }
      }
      return [];
    }

    /* Robust court-number extraction
       - Deep scans any key containing "court" or "resource"
       - Handles arrays/objects and CSV/text fields
    */
    function collectNumbersFromString(str){
      const s = String(str||'').toLowerCase();
      const set = new Set();
      // "Court 1,2,3" or "1-4", "1, 2 & 3"
      let m;
      const rangeRe=/(\d{1,2})\s*[-–]\s*(\d{1,2})/g; while((m=rangeRe.exec(s))!==null){ const a=+m[1], b=+m[2]; for(let i=Math.min(a,b); i<=Math.max(a,b); i++) set.add(i); }
      const listRe=/(?:^|[^\d])(\d{1,2})(?=\s*[,&]|$)/g; while((m=listRe.exec(s))!==null){ set.add(+m[1]); }
      const labeledRe=/(?:court|crt|ct|resource|rm)\s*#?-?\s*(\d{1,2})/g; while((m=labeledRe.exec(s))!==null){ set.add(+m[1]); }
      return set;
    }

    function extractCourtNumbersDeep(value, depth=0){
      const out = new Set();
      if (value == null || depth > 5) return [];
      if (typeof value === 'number' && Number.isFinite(value)) return [value];
      if (typeof value === 'string'){
        collectNumbersFromString(value).forEach(n=>out.add(n));
        // CSV like "1,2,3" without labels
        value.split(/[;,]/).forEach(tok=>{
          const n = parseInt(tok.trim(),10);
          if(Number.isFinite(n)) out.add(n);
        });
        return Array.from(out);
      }
      if (Array.isArray(value)){
        value.forEach(v => extractCourtNumbersDeep(v, depth+1).forEach(n=>out.add(n)));
        return Array.from(out);
      }
      if (typeof value === 'object'){
        // generic fields commonly seen
        const preferred = ['Courts','Court','CourtName','CourtNumber','CourtIds','CourtId','CourtNumbers','CourtsText','CourtNames','CourtNamesCsv','Resources','Resource','ResourceName','ResourceIds'];
        preferred.forEach(k => { if (k in value) extractCourtNumbersDeep(value[k], depth+1).forEach(n=>out.add(n)); });
        // heuristic: scan ALL keys containing "court" or "resource"
        Object.keys(value).forEach(k=>{
          if (/court|resource/i.test(k)) {
            extractCourtNumbersDeep(value[k], depth+1).forEach(n=>out.add(n));
          }
        });
        return Array.from(out);
      }
      return [];
    }

    function matchesCourtAny(record, n){
      if(!record) return true; // permissive fallback
      // try common top-level fields first for speed
      if (Number(record.CourtNumber) === n) return true;
      const nums = extractCourtNumbersDeep(record);
      return nums.includes(n);
    }

    function matchesCourtStrict(record, n){
      const nums = extractCourtNumbersDeep(record);
      return nums.includes(n);
    }

    /* Name resolution for reservations */
    function resolveNameFromReservation(x){
      const players=Array.isArray(x.Players)?x.Players:[];
      const pn=players.map(p=>{
        const fn=(p.FirstName||'').trim(), ln=(p.LastName||'').trim();
        return fn&&ln ? `${fn} ${(ln[0]||'')}.` : (fn+' '+ln).trim();
      }).filter(Boolean);
      if(pn.length) return pn.join(', ');
      const fields=['MemberDisplayName','OrganizerName','Organizer','MemberName','MemberFullName','OwnerName','BookedByName','BookerName','CreatedByName','ReservationOwnerName','PrimaryMemberName','CreatedBy','DisplayName','ReservationName','Title','Description','Notes','PlayersText','CreatedByDisplayName'];
      for(const k of fields){ if(x[k] && String(x[k]).trim()) return String(x[k]).trim(); }
      if(x.ReservationTypeName && x.ReservationTypeName.trim()) return x.ReservationTypeName.trim();
      return 'Reserved';
    }

    /* Auto-fit text */
    const FIT_MAP = {
      'cur-val':   {max:16, min:9},
      'next-val':  {max:16, min:9},
      'cd-val':    {max:22, min:12},
      'clock':     {max:18, min:10},
      'court-val': {max:62, min:28}
    };
    function fitToBox(el, maxPx, minPx){
      if(!el) return;
      let size=maxPx; el.style.fontSize=size+'px';
      const section=el.closest('.section');
      const label=section? section.querySelector('.label') : null;
      const availH=(section? section.clientHeight : el.clientHeight) - (label? label.clientHeight : 0) - 6;
      let guard=60;
      while(guard-- > 0 && size>minPx && (el.scrollWidth > (section.clientWidth-12) || el.scrollHeight > availH)){
        size -= 1; el.style.fontSize=size+'px';
      }
    }
    function fitAll(){
      Object.keys(FIT_MAP).forEach(id=>{
        const el=document.getElementById(id);
        if(el){ const conf=FIT_MAP[id]; fitToBox(el, conf.max, conf.min); }
      });
    }
    window.addEventListener('resize', ()=>{ setTimeout(fitAll, 30); });

    /* Format helpers for NY time */
    function toNYTimeString(date){ return date.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:TZ}); }
    function dayStringInTZ(ms, tz){ const f=new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}); return f.format(new Date(ms)); }

    /* Countdown (Time Left / Time Until) */
    let countdownTimeout=null, nextEventTime=null;
    function startCountdown(target){
      clearTimeout(countdownTimeout);
      function tick(){
        const nowMs=nowSyncMs();
        const diff=target - nowMs;
        const el=document.getElementById('cd-val');

        if(diff>0){
          const totalMin=Math.floor(diff/60000);
          if(diff<=60000){
            const s=Math.floor((diff%60000)/1000);
            el.textContent=s+'s';
          }else if(totalMin>=60){
            const h=Math.floor(totalMin/60); const rem=totalMin%60;
            el.textContent=h+'h '+rem+'m';
          }else{
            el.textContent=totalMin+'m';
          }

          if(diff<=60000){
            const box=document.getElementById('countdown');
            if(box) box.classList.add('under-minute');
            document.body.classList.add('global-under-minute');
            setPulsePhase();
          }else{
            el.style.color='#fff';
            const box=document.getElementById('countdown'); if(box) box.classList.remove('under-minute');
            document.body.classList.remove('global-under-minute');
          }

          fitToBox(el, FIT_MAP['cd-val'].max, FIT_MAP['cd-val'].min);
          const ms=1000 - (nowMs%1000);
          countdownTimeout=setTimeout(tick, ms>250? ms : 250);
        }else{
          el.textContent='Time Expired'; el.style.color='#ff4d4d';
          const box=document.getElementById('countdown'); if(box) box.classList.remove('under-minute');
          document.body.classList.remove('global-under-minute');
          fitToBox(el, FIT_MAP['cd-val'].max, FIT_MAP['cd-val'].min);
          clearTimeout(countdownTimeout);
          setTimeout(()=>{ if(nextEventTime) startCountdown(nextEventTime); else { el.textContent='No Event'; el.style.color='#fff'; fitToBox(el, FIT_MAP['cd-val'].max, FIT_MAP['cd-val'].min);} }, 300000);
        }
      }
      tick();
    }

    /* Clock (NY time) */
    function tickClock(){
      const now=new Date(nowSyncMs());
      const el=document.getElementById('clock');
      el.textContent=now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:TZ});
      fitToBox(el, FIT_MAP['clock'].max, FIT_MAP['clock'].min);
      const delay=1000 - (nowSyncMs()%1000);
      setTimeout(tickClock, Math.max(250, delay));
    }

    /* Fetch JSON — keep headers minimal to match working setup */
    async function fetchJSON(url){
      const r=await fetch(url,{headers:{Authorization:AUTH_B64}});
      if(!r.ok) throw new Error(r.status+' '+r.statusText);
      return r.json();
    }

    /* Refresh data */
    async function refresh(){
      try{
        nextEventTime=null;

        // Build today's window in New York time (YYYY-MM-DD)
        const todayNY=dayStringInTZ(nowSyncMs(), TZ);

        // Known-working endpoints/params
        const evUrl=`https://api.courtreserve.com/api/v1/eventcalendar/eventlist?orgMemberId=${ORG_MEMBER_ID}&startDate=${todayNY}T00:00:00&endDate=${todayNY}T23:59:59`;
        const resUrl=`https://api.courtreserve.com/api/v1/reservationreport/listactive?reservationsFromDate=${todayNY}&reservationsToDate=${todayNY}`;

        const [eRaw,rRaw]=await Promise.all([ fetchJSON(evUrl), fetchJSON(resUrl) ]);

        const eArr=pickArray(eRaw);
        const rArr=pickArray(rRaw);

        const baseDateLocal=new Date(nowSyncMs());

        // EVENTS: permissive but robust deep-scan for court numbers
        const events=eArr.filter(x=> matchesCourtAny(x, COURT_NO))
          .map(x=>{
            const start=parseTimeAny(x.StartDateTime||x.StartTime||x.Start, baseDateLocal);
            const end=parseTimeAny(x.EndDateTime||x.EndTime||x.End, baseDateLocal);
            return { source:'event', rawTitle:x.EventName||x.Name||'Event', name:x.EventName||x.Name||'Event', typeName:x.EventTypeName||x.TypeName||'', start, end };
          });

        // RESERVATIONS: strict match (must explicitly include the court number)
        const resv=rArr.filter(x=> matchesCourtStrict(x, COURT_NO))
          .map(x=>{
            const start=parseTimeAny(x.StartTime||x.StartDateTime||x.Start, baseDateLocal);
            const end=parseTimeAny(x.EndTime||x.EndDateTime||x.End, baseDateLocal);
            return { source:'reservation', rawTitle:x.ReservationName||x.Title||x.Description||resolveNameFromReservation(x), name:resolveNameFromReservation(x), typeName:x.ReservationTypeName||'', start, end };
          });

        const all=events.concat(resv).filter(it=> it.start && it.end).sort((a,b)=> a.start - b.start);

        const nowLocal=new Date(nowSyncMs());
        let cur=null, nxt=null;
        for(const item of all){ if(!cur && nowLocal>=item.start && nowLocal<=item.end) cur=item; if(!nxt && nowLocal<item.start) nxt=item; }
        nextEventTime = nxt ? nxt.start.getTime() : null;

        const curEl=document.getElementById('cur-val');
        const cdLabel=document.getElementById('cd-label');
        const cdVal=document.getElementById('cd-val');
        const nextEl=document.getElementById('next-val');

        if(cur){
          curEl.innerHTML = `${cur.name}<div class='meta'>${toNYTimeString(cur.start)} - ${toNYTimeString(cur.end)}</div>`;
          cdLabel.textContent='Time Left';
          startCountdown(cur.end.getTime());
        }else{
          curEl.textContent='No current event';
          if(nxt){
            cdLabel.textContent='Time Until';
            startCountdown(nxt.start.getTime());
          }else{
            cdVal.textContent='--';
          }
        }

        if(nxt){
          nextEl.innerHTML = `${nxt.name}<div class='meta'>${toNYTimeString(nxt.start)} - ${toNYTimeString(nxt.end)}</div>`;
        }else{
          nextEl.textContent='No upcoming event';
        }

        fitAll();
      }catch(err){
        document.getElementById('cur-val').textContent='Error loading data';
        document.getElementById('next-val').textContent='—';
        fitAll();
      }
    }

    /* Init */
    function init(){
      // Safety: ensure compat backgrounds exist (skip court-number on purpose)
      ['current-event','countdown','next-event','current-time'].forEach(id=>{
        const sec=document.getElementById(id);
        if(sec && !sec.querySelector('.compat-bg')){
          const bg=document.createElement('div'); bg.className='compat-bg';
          sec.insertBefore(bg, sec.firstChild);
        }
      });

      tickClock();
      refresh();
      setInterval(refresh, 30000);
      fitAll();
    }
    document.addEventListener('DOMContentLoaded', init);

    /* ===== TB1-4G hardening tweaks ===== */
    // Re-sync when the player resumes or page becomes visible again
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) {
        syncDrift();
        setPulsePhase();
        refresh();
      }
    });

    // Gently re-lock the animation phase periodically (covers brief throttles)
    setInterval(() => {
      setPulsePhase();
    }, 5000);
  </script>
</body>
</html>
